# Skill/Tool 教程 20：安全、权限、幂等与审计（写入类工具必读）

当 Agent 具备工具调用能力后，风险会从“说错话”升级为“做错事”。尤其是具备**写入能力**的工具（改文件、发请求、创建工单、发通知、部署等）。

这篇教程给你一套工程上常用的安全设计框架，建议你在做任何“写入类 Tool”之前先过一遍。

---

## 1. 风险模型：工具调用为什么危险
典型风险包括：

- **误操作**：模型理解偏差导致执行了错误动作（删库、覆盖文件、发错人）
- **重复执行**：同一请求被重试或被多次触发，造成重复副作用
- **权限滥用**：工具拥有高权限，模型被提示词诱导调用敏感操作
- **数据泄露**：把敏感信息输出到日志或回显给用户
- **不可审计**：出了事故无法追溯“谁在什么时候做了什么”

因此，工具体系要像生产 API 一样设计：权限、审计、回滚、幂等，缺一不可。

---

## 2. 权限（Permissions）：最小权限原则
### 2.1 工具按能力分级
建议把工具分为三类，逐级开放：

1) **只读类**（低风险）
例如：读文件、查数据库、查工单、列目录

2) **计算/生成类**（中风险）
例如：生成报告、生成代码草稿（但不写入）、运行只读分析脚本

3) **写入/执行类**（高风险）
例如：写文件、提交变更、发送通知、触发部署、修改数据库

### 2.2 最小权限原则（Least Privilege）
- 工具只拿到完成任务所需的最小权限
- 能只读就不要写入
- 能写入测试环境就不要写入生产
- 能限制路径就不要让它写任意路径

---

## 3. 人工确认（Human-in-the-loop）：高风险操作必须二次确认
对高风险工具建议引入“确认门槛”：

- 模型先输出“计划与影响面”（将要改哪些文件、将要写什么）
- 用户确认后才执行
- 或者工具层要求 `confirm_token` / `approval_id`

例子（概念）：
- `propose_changes()`：只生成变更草案
- `apply_changes(approval_id=...)`：拿到人工批准后才执行

---

## 4. 幂等（Idempotency）：避免重复副作用
### 4.1 什么是幂等
同一个请求执行一次或执行多次，效果一致。

对于写入类工具，幂等几乎是刚需，因为：
- 网络超时会重试
- Agent 框架可能重复调用
- 用户可能重复点击

### 4.2 常用幂等手段
- **幂等键（idempotency_key）**：由调用方生成（例如 UUID），工具端保存执行记录
- **乐观锁/版本号**：写文件时带上旧版本 hash（只有匹配才写）
- **去重表**：对“已发送通知”“已创建工单”做唯一约束

---

## 5. 审计（Audit）：可追溯才能放心上线
建议每次工具调用都记录：

- `who`：谁触发（用户、系统、服务账号）
- `when`：时间戳
- `what`：调用了哪个工具、输入参数（注意脱敏）
- `result`：成功/失败、错误码、影响范围
- `trace_id`：一次任务的链路 ID（便于串联日志）

### 5.1 日志要注意脱敏
- 不要记录密钥、token、密码
- 不要把用户隐私写进日志
- 如果必须记录，做掩码/哈希

---

## 6. 输入校验（Validation）：把“不可控”挡在工具层
不要相信模型传进来的参数一定正确。

工具层建议做：
- 类型校验（schema）
- 值域校验（例如路径必须在允许目录内）
- 速率限制（rate limit）
- 超时控制（timeout）
- 输出大小限制（避免一次返回超大内容）

---

## 7. 失败与回滚（Failure & Rollback）
写入类工具必须考虑失败情况：
- 部分成功怎么办？
- 写到一半失败怎么办？
- 能否回滚？
- 失败信息是否足够定位（错误码 + message + trace_id）

如果不能回滚，至少要做到：
- 有明确的“影响范围报告”
- 有可操作的“恢复步骤”

---

## 8. 与本仓库 demo 的对应关系（把意识养起来）
你当前 `demos/rag_min/` 只有“读文档、建索引、查询检索”，风险较低。

当你未来加入写入类能力（比如“自动改笔记并提交”）时，建议你按本教程做分层：
- 先做 `propose`（只生成差异/草案）
- 再做 `apply`（带审批、带幂等键、可审计）

把安全设计当成默认配置，而不是出事后的补丁。

---

## 📌 导航
- 上一章：[Skill/Tool 教程 10：工具 schema 设计](./10_tool_schema_design.md)
- 下一章：建议回到 [工作流集成阶段](../../05-工作流集成/README.md)
- 返回总览：[根目录学习导航](../../README.md#-专题学习导航prompt--rag--skill)
